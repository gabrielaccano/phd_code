regal_keep_rows<-regal_row_sums>=5
regal_numeric_filtered<- regal_filtered_outliers[regal_keep_rows, ]
set.seed(82402)
regal_nmds<- metaMDS(regal_numeric_filtered,
distance= "bray",
wascores = TRUE,
trymax= 500,
autotransform = FALSE)
# plot(regal_nmds)
#
nmds_points<- as.data.frame(regal_nmds$points)
#get metadata attached
regal_numeric_filtered$combo_id <- rownames(regal_numeric_filtered)
# Then separate that column back into original parts
parts <- do.call(rbind, strsplit(regal_numeric_filtered$combo_id, "_"))
colnames(parts) <- c("year", "month", "field")
# Bind the split columns to your data frame
matrix_scores <- cbind(parts, nmds_points)
# Optionally remove the combo_id column
regal_filtered_outliers$combo_id <- NULL
ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = cluster)) +
geom_point(size = 3) +
labs(title = "NMDS Clustering") +
theme_minimal()
#plot with species scores
ggplot()+
geom_point(data= matrix_scores, aes(x=MDS1, y=MDS2, shape= as.factor(month)),
size=3)+
geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
stat_ellipse(data= matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
#plot with species scores
ggplot()+
geom_point(data= matrix_scores, aes(x=MDS1, y=MDS2, shape= as.factor(month)),
size=3)+
#geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
stat_ellipse(data= matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
library(lme4)
library(devtools)
library(tidyverse)
library(vegan)
library (readxl)
library(gdata)
library(openxlsx)
library(ggridges)
library(ggpubr)
library(nnet)
library(cowplot)
library(writexl)
okabe_ito_extended <- c(
"#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#D55E00", "#0072B2","#CC79A7", "#999999",  # Original Okabe-Ito (8 colors)
"#882255", "#44AA99", "#117733", "#88CCEE", "#DDCC77",
"#AA4499", "#332288", "#661100", "#BBBBBB", # Previously added (9 colors)
"#6699CC", "#AA7744",
"white", "black", "turquoise", "hotpink" # Two additional colors
)
setwd("C:/Users/GCano/Documents/GitHub/phd_code/")
matrix_98_24<- read_xlsx("C:/Users/GCano/Documents/GitHub/phd_code/butterfly_data_16_24/complete pollard data CRT 7May2025.xlsx"
# col_types = c(
#   "numeric",
#   "numeric",
#   "date",
#   "numeric",
#   "numeric",
#   "text",
#   "text",
#   "text",
#   "text",
#   "text",
#   "text",
#   "numeric",
#   "numeric",
#   "numeric",
#   "numeric",
#   "numeric",
#   "numeric",
#   "numeric",
#   "text",
#   "text",
#   "text",
#   "numeric",
#   "text",
#   "text",
#   "text",
#   "text"
)
#regal sex model -----------------
#fit model with known sexes
known_rg_sex<- matrix_98_24 |>
filter(butterfly_species_cleaned=="ARID") |>
filter(sex %in% c("M", "F"))
#convert sex to binary (male= 1, female= 0)
known_rg_binary<- known_rg_sex |>
mutate(sex_binary= ifelse(sex=="M", 1, 0))
#fit model
unk_sex_model<- glmer(
sex_binary~ year+julian+s_wind+s_temp+s_percent_sun+ year*site + year*observer+
julian*site+
(1|site) + (1|section)+ (1|observer),
data=known_rg_binary,
family = binomial(link="logit")
)
#regal nmds model----------------
regal_prep<- matrix_98_24 |>
filter(butterfly_species=="ARID") |>
# filter(year>=2010) |> #for regals, goes back to '98, can alter here
filter(behavior==3) |>
filter(nectar_species !="NA") #|>
#regal nmds model----------------
regal_prep<- matrix_98_24 |>
filter(butterfly_species_cleaned=="ARID") |>
# filter(year>=2010) |> #for regals, goes back to '98, can alter here
filter(behavior==3) |>
filter(nectar_species !="NA") |>
filter(field!= "Boyer")
regal_prep<- matrix_98_24 |>
filter(butterfly_species_cleaned=="ARID") |>
# filter(year>=2010) |> #for regals, goes back to '98, can alter here
filter(behavior==3) |>
filter(nectar_species_cleaned !="NA") |>
filter(field!= "Boyer")
#regal nmds model----------------
regal_prep<- matrix_98_24 |>
filter(butterfly_species_cleaned=="ARID") |>
# filter(year>=2010) |> #for regals, goes back to '98, can alter here
filter(behavior==3) |>
filter(nectar_species_cleaned !="NA") |>
filter(field!= "Boyer")
regal_dist_matrix<- regal_prep |>
count(year, month, nectar_species_cleaned) |>
pivot_wider(names_from = nectar_species_cleaned,
values_from = n,
values_fill = list(n = 0))
# #Remove outlier columns
# regal_nectar_counts <- colSums(regal_dist_matrix != 0)
# regal_keep_cols<- regal_nectar_counts>=10
# regal_filtered_outliers<- regal_dist_matrix[, regal_keep_cols]
# regal_filtered_outliers<- as.data.frame(regal_filtered_outliers)
rownames(regal_dist_matrix) <- paste(regal_dist_matrix$year,
regal_dist_matrix$month,
regal_dist_matrix$field,
sep = "_")
#remove metadata
regal_numeric_only <- as.data.frame(regal_dist_matrix[, !(names(regal_dist_matrix) %in% c("year", "month", "field"))])
rownames(regal_numeric_only) <- rownames(regal_dist_matrix)
#remove outlier columns and rows
regal_nectar_counts <- colSums(regal_numeric_only != 0)
regal_keep_cols<- regal_nectar_counts>=10
regal_filtered_outliers<- regal_numeric_only[, regal_keep_cols]
regal_row_sums <- rowSums(regal_filtered_outliers, na.rm = TRUE)
regal_keep_rows<-regal_row_sums>=5
regal_numeric_filtered<- regal_filtered_outliers[regal_keep_rows, ]
str(regal_numeric_filtered)
set.seed(82402)
regal_nmds<- metaMDS(regal_numeric_filtered,
distance= "bray",
wascores = TRUE,
trymax= 500,
autotransform = FALSE)
regal_plant_scores<-scores(arid_nmds, display= "species")
regal_plant_scores<-scores(regal_nmds, display= "species")
regal_plant_df<-as.data.frame(regal_plant_scores)
regal_plant_df$nectar_species_cleaned<-rownames(regal_plant_df)
# plot(regal_nmds)
#
nmds_points<- as.data.frame(regal_nmds$points)
#get metadata attached
regal_numeric_filtered$combo_id <- rownames(regal_numeric_filtered)
# Then separate that column back into original parts
parts <- do.call(rbind, strsplit(regal_numeric_filtered$combo_id, "_"))
colnames(parts) <- c("year", "month", "field")
# Bind the split columns to your data frame
matrix_scores <- cbind(parts, nmds_points)
# Optionally remove the combo_id column
regal_filtered_outliers$combo_id <- NULL
#clustering! (spoiler, the cluster is by month)
kmeans_result <- kmeans(nmds_points, centers = 5)
clusters <- kmeans_result$cluster
nmds_points$cluster <- as.factor(clusters)
ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = cluster)) +
geom_point(size = 3) +
labs(title = "NMDS Clustering") +
theme_minimal()
#plot with species scores
ggplot()+
geom_point(data= matrix_scores, aes(x=MDS1, y=MDS2, shape= as.factor(month)),
size=3)+
#geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
stat_ellipse(data= matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
#plot with species scores
ggplot()+
geom_point(data= matrix_scores, aes(x=MDS1, y=MDS2, shape= as.factor(month)),
size=3)+
geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
stat_ellipse(data= matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
#plot with month polygons
ggplot()+
geom_point(data= arid_matrix_scores, aes(x=MDS1, y=MDS2, color= as.factor(month), shape= as.factor(month)),
size=3)+
geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
geom_polygon(data = arid_hull_data_month,
aes(x = MDS1, y = MDS2, group = month, fill = as.factor(month)),
alpha = 0.1, color = "black")+
scale_shape_manual(values = c(15, 17, 19, 8)) +  # square, triangle, circle
scale_fill_manual(values= okabe_ito_extended) +
scale_color_manual(values = okabe_ito_extended)+
stat_ellipse(data= arid_matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
#plot with month polygons
ggplot()+
geom_point(data= matrix_scores, aes(x=MDS1, y=MDS2, color= as.factor(month), shape= as.factor(month)),
size=3)+
geom_label(data= regal_plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
geom_polygon(data = arid_hull_data_month,
aes(x = MDS1, y = MDS2, group = month, fill = as.factor(month)),
alpha = 0.1, color = "black")+
scale_shape_manual(values = c(15, 17, 19, 8)) +  # square, triangle, circle
scale_fill_manual(values= okabe_ito_extended) +
scale_color_manual(values = okabe_ito_extended)+
stat_ellipse(data= arid_matrix_scores, aes(x=MDS1,y=MDS2, color=month),level = 0.50)
#finding convex hulls for the months
hull_data_month<-matrix_scores |>
group_by(month) |>
slice(chull(MDS1, MDS2))
library(vegan)
library(tidyverse)
library(rlang)
library(readxl)
library(ggridges)
library(writexl)
okabe_ito_extended <- c(
"#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#D55E00", "#0072B2","#CC79A7", "#999999",  # Original Okabe-Ito (8 colors)
"#882255", "#44AA99", "#117733", "#88CCEE", "#DDCC77",
"#AA4499", "#332288", "#661100", "#BBBBBB", # Previously added (9 colors)
"#6699CC", "#AA7744",
"white", "black", "turquoise", "hotpink" # Two additional colors
)
plant_colors<-c(
"APOCY" = "hotpink",
"ASIN" = "#56B4E9",
"ASSY" = "#009E73",
"ASTER" = "#F0E442",
"ASTU" = "#D55E00",
"CENTA" = "#0072B2",
"CIAR4" = "#999999",
"CIDI" = "#117733",
"CIPU4" = "turquoise",
"ERIGE2" = "#44AA99",
"EUPAT" = "#88CCEE",
"EUPE3" =  "#DDCC77",
"EUTRO" = "#AA4499",
"LESPE" = "#332288",
"LEVU" = "#661100",
"MOFI2" = "#882255",
"Other" = "#BBBBBB",
"PENS" = "#6699CC",
"PRUNE" = "#AA7744",
"PYCNA" = "purple",
"ROMU" = "black",
"SOLID" = "#E69F00"
)
setwd("C:/Users/tut43799/OneDrive - Temple University/Documents/GitHub/phd_code")
okabe_ito_extended <- c(
"#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#D55E00", "#0072B2","#CC79A7", "#999999",  # Original Okabe-Ito (8 colors)
"#882255", "#44AA99", "#117733", "#88CCEE", "#DDCC77",
"#AA4499", "#332288", "#661100", "#BBBBBB", # Previously added (9 colors)
"#6699CC", "#AA7744",
"white", "black", "turquoise", "hotpink" # Two additional colors
)
plant_colors<-c(
"APOCY" = "hotpink",
"ASIN" = "#56B4E9",
"ASSY" = "#009E73",
"ASTER" = "#F0E442",
"ASTU" = "#D55E00",
"CENTA" = "#0072B2",
"CIAR4" = "#999999",
"CIDI" = "#117733",
"CIPU4" = "turquoise",
"ERIGE2" = "#44AA99",
"EUPAT" = "#88CCEE",
"EUPE3" =  "#DDCC77",
"EUTRO" = "#AA4499",
"LESPE" = "#332288",
"LEVU" = "#661100",
"MOFI2" = "#882255",
"Other" = "#BBBBBB",
"PENS" = "#6699CC",
"PRUNE" = "#AA7744",
"PYCNA" = "purple",
"ROMU" = "black",
"SOLID" = "#E69F00"
)
matrix_98_24<- read_xlsx("C:/Users/GCano/Documents/GitHub/phd_code/butterfly_data_16_24/complete pollard data CRT_October2025.xlsx")
run_nmds_plot <- function(species_name) {
# Dynamically build variable names
prefix <- tolower(species_name)
# Step 1: Filter and prep data
prep <- matrix_98_24 |>
filter(butterfly_species_cleaned == species_name) |>
filter(behavior == 3) |>
filter(!is.na(nectar_species_cleaned), field != "Boyer") |>
filter(nectar_species_cleaned!= "NA", field != "Middle Creek")
dist_matrix <- prep |>
count(year, month, field, nectar_species_cleaned) |>
pivot_wider(names_from = nectar_species_cleaned,
values_from = n,
values_fill = list(n = 0))
rownames(dist_matrix) <- paste(dist_matrix$year, dist_matrix$month, dist_matrix$field, sep = "_")
numeric_only <- as.data.frame(dist_matrix[, !(names(dist_matrix) %in% c("year", "month", "field"))])
rownames(numeric_only) <- rownames(dist_matrix)
nectar_counts <- colSums(numeric_only != 0)
keep_cols <- nectar_counts >= 10
filtered_outliers <- numeric_only[, keep_cols]
row_sums <- rowSums(filtered_outliers, na.rm = TRUE)
keep_rows <- row_sums >= 5
numeric_filtered <- filtered_outliers[keep_rows, ]
# Step 2: NMDS
set.seed(82402)
nmds <- metaMDS(numeric_filtered,
distance = "bray",
wascores = TRUE,
trymax = 500,
autotransform = FALSE)
nmds_points <- as.data.frame(nmds$points)
numeric_filtered$combo_id <- rownames(numeric_filtered)
parts <- do.call(rbind, strsplit(numeric_filtered$combo_id, "_"))
colnames(parts) <- c("year", "month", "field")
matrix_scores <- cbind(parts, nmds_points)
# Convex hulls by month
hull_data_month <- matrix_scores |>
group_by(month) |>
slice(chull(MDS1, MDS2))
# Colors
okabe_ito_extended <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#0072B2", "#D55E00", "#CC79A7", "#999999")
#plant scores
plant_scores<-scores(dapl_nmds, display= "species")
plant_df<-as.data.frame(dapl_plant_scores)
plant_df$nectar_species_cleaned<-rownames(dapl_plant_df)
# Plot
p <- ggplot() +
geom_point(data = matrix_scores, aes(x = MDS1, y = MDS2, color = as.factor(month), shape = as.factor(month)),
size = 3) +
geom_label(data= plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
geom_polygon(data = hull_data_month,
aes(x = MDS1, y = MDS2, group = month, fill = as.factor(month)),
alpha = 0.1, color = "black") +
scale_fill_manual(values = okabe_ito_extended) +
scale_color_manual(values = okabe_ito_extended) +
stat_ellipse(data = matrix_scores, aes(x = MDS1, y = MDS2, color = month), level = 0.50) +
labs(title = paste("NMDS of nectar use for", species_name)) +
theme_minimal()
# Save objects to global environment if needed
assign(paste0(prefix, "_prep"), prep, envir = .GlobalEnv)
assign(paste0(prefix, "_dist_matrix"), dist_matrix, envir = .GlobalEnv)
assign(paste0(prefix, "_numeric_filtered"), numeric_filtered, envir = .GlobalEnv)
assign(paste0(prefix, "_nmds"), nmds, envir = .GlobalEnv)
assign(paste0(prefix, "_matrix_scores"), matrix_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_hull_data_month"), hull_data_month, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_scores"), plant_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_df"), plant_df, envir = .GlobalEnv)
return(p)
}
run_nmds_plot("ARID")
run_nmds_plot <- function(species_name) {
# Dynamically build variable names
prefix <- tolower(species_name)
# Step 1: Filter and prep data
prep <- matrix_98_24 |>
filter(butterfly_species_cleaned == species_name) |>
filter(behavior == 3) |>
filter(!is.na(nectar_species_cleaned), field != "Boyer") |>
filter(nectar_species_cleaned!= "NA", field != "Middle Creek")
dist_matrix <- prep |>
count(year, month, field, nectar_species_cleaned) |>
pivot_wider(names_from = nectar_species_cleaned,
values_from = n,
values_fill = list(n = 0))
rownames(dist_matrix) <- paste(dist_matrix$year, dist_matrix$month, dist_matrix$field, sep = "_")
numeric_only <- as.data.frame(dist_matrix[, !(names(dist_matrix) %in% c("year", "month", "field"))])
rownames(numeric_only) <- rownames(dist_matrix)
nectar_counts <- colSums(numeric_only != 0)
keep_cols <- nectar_counts >= 10
filtered_outliers <- numeric_only[, keep_cols]
row_sums <- rowSums(filtered_outliers, na.rm = TRUE)
keep_rows <- row_sums >= 5
numeric_filtered <- filtered_outliers[keep_rows, ]
# Step 2: NMDS
set.seed(82402)
nmds <- metaMDS(numeric_filtered,
distance = "bray",
wascores = TRUE,
trymax = 500,
autotransform = FALSE)
nmds_points <- as.data.frame(nmds$points)
numeric_filtered$combo_id <- rownames(numeric_filtered)
parts <- do.call(rbind, strsplit(numeric_filtered$combo_id, "_"))
colnames(parts) <- c("year", "month", "field")
matrix_scores <- cbind(parts, nmds_points)
# Convex hulls by month
hull_data_month <- matrix_scores |>
group_by(month) |>
slice(chull(MDS1, MDS2))
# Colors
okabe_ito_extended <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#0072B2", "#D55E00", "#CC79A7", "#999999")
#plant scores
plant_scores<-scores(_nmds, display= "species")
plant_df<-as.data.frame(_plant_scores)
plant_df$nectar_species_cleaned<-rownames(_plant_df)
# Plot
p <- ggplot() +
geom_point(data = matrix_scores, aes(x = MDS1, y = MDS2, color = as.factor(month), shape = as.factor(month)),
size = 3) +
geom_label(data= plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
geom_polygon(data = hull_data_month,
aes(x = MDS1, y = MDS2, group = month, fill = as.factor(month)),
alpha = 0.1, color = "black") +
scale_fill_manual(values = okabe_ito_extended) +
scale_color_manual(values = okabe_ito_extended) +
stat_ellipse(data = matrix_scores, aes(x = MDS1, y = MDS2, color = month), level = 0.50) +
labs(title = paste("NMDS of nectar use for", species_name)) +
theme_minimal()
# Save objects to global environment if needed
assign(paste0(prefix, "_prep"), prep, envir = .GlobalEnv)
assign(paste0(prefix, "_dist_matrix"), dist_matrix, envir = .GlobalEnv)
assign(paste0(prefix, "_numeric_filtered"), numeric_filtered, envir = .GlobalEnv)
assign(paste0(prefix, "_nmds"), nmds, envir = .GlobalEnv)
assign(paste0(prefix, "_matrix_scores"), matrix_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_hull_data_month"), hull_data_month, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_scores"), plant_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_df"), plant_df, envir = .GlobalEnv)
return(p)
}
run_nmds_plot <- function(species_name) {
# Dynamically build variable names
prefix <- tolower(species_name)
# Step 1: Filter and prep data
prep <- matrix_98_24 |>
filter(butterfly_species_cleaned == species_name) |>
filter(behavior == 3) |>
filter(!is.na(nectar_species_cleaned), field != "Boyer") |>
filter(nectar_species_cleaned!= "NA", field != "Middle Creek")
dist_matrix <- prep |>
count(year, month, field, nectar_species_cleaned) |>
pivot_wider(names_from = nectar_species_cleaned,
values_from = n,
values_fill = list(n = 0))
rownames(dist_matrix) <- paste(dist_matrix$year, dist_matrix$month, dist_matrix$field, sep = "_")
numeric_only <- as.data.frame(dist_matrix[, !(names(dist_matrix) %in% c("year", "month", "field"))])
rownames(numeric_only) <- rownames(dist_matrix)
nectar_counts <- colSums(numeric_only != 0)
keep_cols <- nectar_counts >= 10
filtered_outliers <- numeric_only[, keep_cols]
row_sums <- rowSums(filtered_outliers, na.rm = TRUE)
keep_rows <- row_sums >= 5
numeric_filtered <- filtered_outliers[keep_rows, ]
# Step 2: NMDS
set.seed(82402)
nmds <- metaMDS(numeric_filtered,
distance = "bray",
wascores = TRUE,
trymax = 500,
autotransform = FALSE)
nmds_points <- as.data.frame(nmds$points)
numeric_filtered$combo_id <- rownames(numeric_filtered)
parts <- do.call(rbind, strsplit(numeric_filtered$combo_id, "_"))
colnames(parts) <- c("year", "month", "field")
matrix_scores <- cbind(parts, nmds_points)
# Convex hulls by month
hull_data_month <- matrix_scores |>
group_by(month) |>
slice(chull(MDS1, MDS2))
# Colors
okabe_ito_extended <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442",
"#0072B2", "#D55E00", "#CC79A7", "#999999")
#plant scores
plant_scores <- scores(nmds, display = "species")
plant_df <- as.data.frame(plant_scores)
plant_df$nectar_species_cleaned <- rownames(plant_df)
# Plot
p <- ggplot() +
geom_point(data = matrix_scores, aes(x = MDS1, y = MDS2, color = as.factor(month), shape = as.factor(month)),
size = 3) +
geom_label(data= plant_df, aes(x= NMDS1, y=NMDS2, label= nectar_species_cleaned))+
geom_polygon(data = hull_data_month,
aes(x = MDS1, y = MDS2, group = month, fill = as.factor(month)),
alpha = 0.1, color = "black") +
scale_fill_manual(values = okabe_ito_extended) +
scale_color_manual(values = okabe_ito_extended) +
stat_ellipse(data = matrix_scores, aes(x = MDS1, y = MDS2, color = month), level = 0.50) +
labs(title = paste("NMDS of nectar use for", species_name)) +
theme_minimal()
# Save objects to global environment if needed
assign(paste0(prefix, "_prep"), prep, envir = .GlobalEnv)
assign(paste0(prefix, "_dist_matrix"), dist_matrix, envir = .GlobalEnv)
assign(paste0(prefix, "_numeric_filtered"), numeric_filtered, envir = .GlobalEnv)
assign(paste0(prefix, "_nmds"), nmds, envir = .GlobalEnv)
assign(paste0(prefix, "_matrix_scores"), matrix_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_hull_data_month"), hull_data_month, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_scores"), plant_scores, envir = .GlobalEnv)
assign(paste0(prefix, "_plant_df"), plant_df, envir = .GlobalEnv)
return(p)
}
run_nmds_plot("ARID")
matrix_98_24<- matrix_98_24 |>
mutate(month = as.integer(month))
run_nmds_plot("ARID")
run_nmds_plot("DAPL")
run_nmds_plot("ARCA")
